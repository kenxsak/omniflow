rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // SIMPLIFIED PRODUCTION RULES
    // ==========================================
    // These rules allow authenticated users to access their data
    // Server-side Admin SDK bypasses these rules for sensitive operations
    
    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    
    // ==========================================
    // USERS COLLECTION
    // ==========================================
    // Users can read/update their own profile
    // Users can read other users in their company (for team features)
    match /users/{userId} {
      // Allow users to read their own document always
      // Allow reading other users if authenticated (for team management)
      allow read: if isAuthenticated();
      
      // Users can update their own profile
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // User creation happens via server-side Admin SDK during signup
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Delete only via Admin SDK
      allow delete: if false;
    }
    
    
    // ==========================================
    // COMPANIES COLLECTION
    // ==========================================
    // Authenticated users can read companies (needed for auth context)
    // Updates handled by Admin SDK for sensitive operations
    match /companies/{companyId} {
      // Allow authenticated users to read companies
      allow read: if isAuthenticated();
      
      // Allow authenticated users to update their company (for profile updates)
      allow update: if isAuthenticated();
      
      // Company creation via Admin SDK during signup
      allow create: if isAuthenticated();
      
      // Delete only via Admin SDK
      allow delete: if false;
      
      
      // ==========================================
      // AUTOMATIONS SUBCOLLECTION
      // ==========================================
      match /automations/{automationId} {
        allow read, write: if isAuthenticated();
      }
      
      
      // ==========================================
      // AUTOMATION STATES SUBCOLLECTION
      // ==========================================
      match /automationStates/{stateId} {
        allow read, write: if isAuthenticated();
      }
      
      
      // ==========================================
      // INTEGRATIONS SUBCOLLECTION
      // ==========================================
      match /integrations/{integrationId} {
        allow read, write: if isAuthenticated();
      }
      
      
      // ==========================================
      // FACEBOOK WEBHOOK LOGS SUBCOLLECTION
      // ==========================================
      match /facebookWebhookLogs/{logId} {
        allow read: if isAuthenticated();
        // Write operations via Admin SDK only (webhook handler)
        allow write: if false;
      }
      
      
      // ==========================================
      // USERS SUBCOLLECTION (Chat Sessions)
      // ==========================================
      match /users/{userId} {
        match /chatSessions/{sessionId} {
          allow read, write: if isAuthenticated() && request.auth.uid == userId;
          
          match /messages/{messageId} {
            allow read, write: if isAuthenticated() && request.auth.uid == userId;
          }
        }
      }
    }
    
    
    // ==========================================
    // SOCIAL POSTS COLLECTION
    // ==========================================
    match /socialPosts/{postId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // LEADS COLLECTION
    // ==========================================
    match /leads/{leadId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // QUOTES COLLECTION
    // ==========================================
    match /quotes/{quoteId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // TASKS COLLECTION
    // ==========================================
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // CAMPAIGNS COLLECTION (Email Campaigns)
    // ==========================================
    match /campaigns/{campaignId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // INVITATIONS COLLECTION
    // ==========================================
    match /invitations/{invitationId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // ATTENDANCE COLLECTION
    // ==========================================
    match /attendance/{recordId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // PLANS COLLECTION
    // ==========================================
    // Everyone can read plans (for pricing page)
    match /plans/{planId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    
    // ==========================================
    // FEATURES COLLECTION
    // ==========================================
    // Everyone can read features
    match /features/{featureId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    
    // ==========================================
    // SETTINGS COLLECTION
    // ==========================================
    // Everyone can read settings (for trial information)
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    
    // ==========================================
    // PAYMENT TRANSACTIONS COLLECTION
    // ==========================================
    match /paymentTransactions/{transactionId} {
      allow read: if isAuthenticated();
      // Write operations via Admin SDK only
      allow write: if false;
    }
    
    
    // ==========================================
    // RAZORPAY ORDERS COLLECTION
    // ==========================================
    match /razorpayOrders/{orderId} {
      allow read: if isAuthenticated();
      // Write operations via Admin SDK only
      allow write: if false;
    }
    
    
    // ==========================================
    // STRIPE CUSTOMERS COLLECTION
    // ==========================================
    match /stripeCustomers/{customerId} {
      allow read: if isAuthenticated();
      // Write operations via Admin SDK only
      allow write: if false;
    }
    
    
    // ==========================================
    // ONBOARDING PROGRESS COLLECTION
    // ==========================================
    match /onboardingProgress/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // AI USAGE COLLECTION
    // ==========================================
    match /aiUsage/{usageId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // DIGITAL CARDS COLLECTION
    // ==========================================
    match /digitalCards/{cardId} {
      // Anyone can read published cards (for public viewing)
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    
    // ==========================================
    // LANDING PAGES COLLECTION
    // ==========================================
    match /landingPages/{pageId} {
      // Anyone can read published pages (for public viewing)
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    
    // ==========================================
    // APPOINTMENTS COLLECTION
    // ==========================================
    match /appointments/{appointmentId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // DEALS/PIPELINE COLLECTION
    // ==========================================
    match /deals/{dealId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // SCHEDULED POSTS COLLECTION
    // ==========================================
    match /scheduledPosts/{postId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // EMAIL CAMPAIGNS COLLECTION
    // ==========================================
    match /email_campaigns/{campaignId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // CONTACT LISTS COLLECTION
    // ==========================================
    match /contactLists/{listId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // AUDIT LOGS COLLECTION
    // ==========================================
    match /auditLogs/{logId} {
      allow read: if isAuthenticated();
      // Write operations via Admin SDK only
      allow write: if false;
    }
    
    
    // ==========================================
    // WORKFLOWS COLLECTION
    // ==========================================
    match /workflows/{workflowId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // SOCIAL ACCOUNTS COLLECTION
    // ==========================================
    match /socialAccounts/{accountId} {
      allow read, write: if isAuthenticated();
    }
    
    
    // ==========================================
    // DEFAULT DENY
    // ==========================================
    // Deny access to any other collections not explicitly defined
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
